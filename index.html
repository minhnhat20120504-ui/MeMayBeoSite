<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>FPS Training Map</title>
<style>
  body { margin:0; overflow:hidden; background:#000; cursor:crosshair }
  canvas { display:block }
  #info {
    position:fixed; top:10px; left:10px;
    color:#0f0; font-family:monospace;
    background:rgba(0,0,0,.6); padding:6px 10px;
  }
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="info">Click để vào game<br>WASD di chuyển · Chuột xoay · Click bắn</div>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
resize();
window.onresize = resize;

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}

const map = [
  "1111111111",
  "1000000001",
  "1011111101",
  "1000000001",
  "1000110001",
  "1000000001",
  "1111111111"
];

const TILE = 64;
const FOV = Math.PI / 3;
const RAYS = 300;
const DEPTH = 800;

const player = {
  x: 2.5 * TILE,
  y: 2.5 * TILE,
  a: 0,
  speed: 2
};

const keys = {};
onkeydown = e => keys[e.key.toLowerCase()] = true;
onkeyup   = e => keys[e.key.toLowerCase()] = false;

canvas.onclick = () => canvas.requestPointerLock();

document.addEventListener("mousemove", e=>{
  if(document.pointerLockElement === canvas){
    player.a += e.movementX * 0.002;
  }
});

const targets = [
  {x:5.5*TILE, y:2.5*TILE, alive:true},
  {x:7.5*TILE, y:4.5*TILE, alive:true}
];

function wall(x,y){
  const mx = Math.floor(x/TILE);
  const my = Math.floor(y/TILE);
  return map[my]?.[mx] === "1";
}

function update(){
  let nx = player.x;
  let ny = player.y;

  if(keys["w"]){ nx += Math.cos(player.a)*player.speed; ny += Math.sin(player.a)*player.speed }
  if(keys["s"]){ nx -= Math.cos(player.a)*player.speed; ny -= Math.sin(player.a)*player.speed }
  if(keys["a"]){ nx += Math.cos(player.a-Math.PI/2)*player.speed; ny += Math.sin(player.a-Math.PI/2)*player.speed }
  if(keys["d"]){ nx += Math.cos(player.a+Math.PI/2)*player.speed; ny += Math.sin(player.a+Math.PI/2)*player.speed }

  if(!wall(nx, player.y)) player.x = nx;
  if(!wall(player.x, ny)) player.y = ny;
}

canvas.addEventListener("mousedown", ()=>{
  const ax = Math.cos(player.a);
  const ay = Math.sin(player.a);
  targets.forEach(t=>{
    if(!t.alive) return;
    const dx = t.x - player.x;
    const dy = t.y - player.y;
    const dist = Math.hypot(dx,dy);
    const dot = (dx/dist)*ax + (dy/dist)*ay;
    if(dot > 0.98 && dist < 400){
      t.alive = false;
    }
  });
});

function draw(){
  ctx.fillStyle="#222";
  ctx.fillRect(0,0,canvas.width,canvas.height/2);
  ctx.fillStyle="#555";
  ctx.fillRect(0,canvas.height/2,canvas.width,canvas.height/2);

  for(let i=0;i<RAYS;i++){
    const rayA = player.a - FOV/2 + FOV*i/RAYS;
    for(let d=0; d<DEPTH; d+=4){
      const rx = player.x + Math.cos(rayA)*d;
      const ry = player.y + Math.sin(rayA)*d;
      if(wall(rx,ry)){
        const h = (TILE*600)/(d*Math.cos(rayA-player.a));
        ctx.fillStyle = `rgb(${200-d/4},${200-d/4},${200-d/4})`;
        ctx.fillRect(
          i*(canvas.width/RAYS),
          canvas.height/2-h/2,
          canvas.width/RAYS+1,
          h
        );
        break;
      }
    }
  }

  targets.forEach(t=>{
    if(!t.alive) return;
    const dx = t.x-player.x;
    const dy = t.y-player.y;
    const dist = Math.hypot(dx,dy);
    const ang = Math.atan2(dy,dx)-player.a;
    if(Math.abs(ang) < FOV/2){
      const size = 600/dist;
      const x = canvas.width/2 + Math.tan(ang)*canvas.width;
      ctx.fillStyle="red";
      ctx.fillRect(x-size/2,canvas.height/2-size,size,size);
    }
  });

  ctx.strokeStyle="#fff";
  ctx.beginPath();
  ctx.moveTo(canvas.width/2-5,canvas.height/2);
  ctx.lineTo(canvas.width/2+5,canvas.height/2);
  ctx.moveTo(canvas.width/2,canvas.height/2-5);
  ctx.lineTo(canvas.width/2,canvas.height/2+5);
  ctx.stroke();
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
